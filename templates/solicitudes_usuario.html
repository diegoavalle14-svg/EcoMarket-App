<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EcoMarket - Solicitudes</title>
<style>
/* ====== General ====== */
body {
    font-family: "Poppins", sans-serif;
    background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
    margin: 0;
    color: #2e7d32;
}
header {
    background: #43a047;
    color: white;
    padding: 20px;
    text-align: center;
    font-size: 2em;
    font-weight: 700;
    box-shadow: 0 3px 10px rgba(0,0,0,0.2);
    position: relative; /* IMPORTANTE para que el botón se posicione dentro */
}
header a {
    position: absolute;
    right: 20px;
    top: 50%;
    transform: translateY(-50%);
    background: #388e3c;
    color: white;
    padding: 8px 16px;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 600;
}
header a:hover {
    background: #2e7d32;
}

.container {
    display: flex;
    gap: 20px;
    padding: 20px;
    flex-wrap: wrap;
    max-width: 1200px;
    margin: auto;
}
.form-box, .table-box {
    background: white;
    padding: 20px;
    border-radius: 15px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    flex: 1 1 400px;
}

/* ====== Formulario ====== */
.form-box h2 {
    text-align: center;
    margin-bottom: 15px;
}
.form-group {
    display: flex;
    flex-direction: column;
    margin-bottom: 12px;
}
.form-group label {
    font-weight: 600;
    margin-bottom: 5px;
}
.form-group input, 
.form-group textarea, 
.form-group select {
    padding: 10px;
    border-radius: 10px;
    border: 1px solid #a5d6a7;
    font-size: 14px;
    font-family: inherit;
}
button {
    width: 100%;
    padding: 12px;
    background: linear-gradient(90deg, #43a047, #66bb6a);
    color: white;
    font-weight: 600;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    transition: background 0.3s;
}
button:hover { background: linear-gradient(90deg, #388e3c, #43a047); }

/* ====== Tabla de solicitudes ====== */
.table-box h2 {
    text-align: center;
    margin-bottom: 15px;
}
table {
    width: 100%;
    border-collapse: collapse;
}
th, td {
    padding: 10px;
    text-align: left;
    border-bottom: 1px solid #c8e6c9;
}
th {
    background-color: #66bb6a;
    color: white;
    font-weight: 600;
}
.status {
    font-weight: 600;
    padding: 3px 8px;
    border-radius: 8px;
    color: white;
}
.pendiente { background-color: #fbc02d; }
.aprobada { background-color: #43a047; }
.rechazada { background-color: #e53935; }

/* Mensaje */
#message {
    text-align: center;
    font-weight: 600;
    margin-bottom: 10px;
    color: #2e7d32;
}
</style>
</head>
<body>

<header>
    EcoMarket - Solicitudes
    <a href="/ecomarket">⬅ Volver al menú</a>
</header>

<div class="container">

    <!-- FORMULARIO -->
    <div class="form-box">
        <h2>Enviar Solicitud</h2>
        <div id="message"></div>
        <form id="solicitudForm">
            <div class="form-group">
                <label for="tipo">Tipo de solicitud</label>
                <select id="tipo" name="tipo" required>
                    <option value="">Seleccione...</option>
                    <option value="Donar">Donar</option>
                    <option value="Intercambiar">Intercambiar</option>
                    <option value="Adquirir">Adquirir</option>
                </select>
            </div>
            <div class="form-group">
                <label for="producto_nombre">Nombre del producto</label>
                <input type="text" id="producto_nombre" name="producto_nombre" required>
            </div>
            <div class="form-group">
                <label for="descripcion">Descripción</label>
                <textarea id="descripcion" name="descripcion" rows="3"></textarea>
            </div>
            <button type="submit">Enviar Solicitud</button>
        </form>
    </div>

    <!-- TABLA DE SOLICITUDES -->
    <div class="table-box">
        <h2>Mis Solicitudes</h2>
        <table>
            <thead>
                <tr>
                    <th>Tipo</th>
                    <th>Producto</th>
                    <th>Descripción</th>
                    <th>Estado</th>
                    <th>Fecha</th>
                </tr>
            </thead>
            <tbody id="solicitudesTable"></tbody>
        </table>
    </div>

</div>

<script>
const API_BASE = "http://127.0.0.1:8000";

// Función para cargar solicitudes del usuario
async function cargarSolicitudes() {
    try {
        const res = await fetch(`${API_BASE}/api/solicitudes_usuario`);
        if(!res.ok) throw new Error("Error al cargar solicitudes");
        const data = await res.json();
        const tbody = document.getElementById("solicitudesTable");
        tbody.innerHTML = "";
        data.forEach(s => {
            const tr = document.createElement("tr");
            let statusClass = "";
            if(s.estado.toLowerCase() === "pendiente") statusClass = "pendiente";
            else if(s.estado.toLowerCase() === "aprobada") statusClass = "aprobada";
            else if(s.estado.toLowerCase() === "rechazada") statusClass = "rechazada";
            tr.innerHTML = `
                <td>${s.tipo}</td>
                <td>${s.producto_nombre}</td>
                <td>${s.descripcion || ""}</td>
                <td><span class="status ${statusClass}">${s.estado}</span></td>
                <td>${new Date(s.created_at).toLocaleString()}</td>
            `;
            tbody.appendChild(tr);
        });
    } catch(err) {
        console.error(err);
    }
}

// Manejar envío de solicitud
document.getElementById("solicitudForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const message = document.getElementById("message");
    const form = e.target;
    const formData = new FormData(form);
    try {
        const res = await fetch(`${API_BASE}/solicitudes/create`, { // <--- endpoint corregido
            method: "POST",
            body: formData
        });
        if(!res.ok) throw new Error("Error al enviar la solicitud");
        message.textContent = "Solicitud enviada correctamente ✅";
        form.reset();
        cargarSolicitudes();
    } catch(err) {
        message.textContent = "Error al enviar la solicitud ❌";
        console.error(err);
    }
});

// Carga inicial
cargarSolicitudes();
</script>

</body>
</html>
