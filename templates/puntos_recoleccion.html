<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EcoMarket - Puntos de Recolección</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family: 'Poppins', Arial, sans-serif; background: linear-gradient(135deg,#e8f5e9,#c8e6c9); color:#2e7d32; height:100vh; display:flex; flex-direction:column; }

.header { text-align:center; background: linear-gradient(90deg,#165c19,#43a047); color:white; padding:20px; border-radius: 0 0 20px 20px; box-shadow:0 5px 15px rgba(0,0,0,0.25);}
.header h1 { font-size:3em; font-weight:800; text-shadow:2px 3px 6px rgba(0,0,0,0.25);}
.header p { margin-top:5px; font-size:1em; font-weight:500;}
.header .btn-back { display:inline-block; margin-top:10px; padding:10px 16px; background:linear-gradient(90deg,#43a047,#66bb6a); color:white; text-decoration:none; font-weight:600; border-radius:14px;}
.header .btn-back:hover { background:linear-gradient(90deg,#388e3c,#43a047); }

.main-content { flex:1; display:flex; height:calc(100% - 100px); } /* resto de altura para el contenido */

.form-section {
    width:350px;
    background:white;
    padding:20px;
    border-radius:20px;
    box-shadow:0 10px 25px rgba(76,175,80,0.2);
    margin:20px;
    overflow-y:auto;
}

#map {
    flex:1;
    height:100%;
    margin:20px 20px 20px 0;
    border-radius:15px;
}

h2 { color:#2e7d32; margin-bottom:15px; font-size:1.4em; }
.form-group { margin-bottom:12px; }
label { display:block; margin-bottom:5px; font-weight:600; }
input { width:100%; padding:8px; border-radius:8px; border:2px solid #c8e6c9; font-size:1em;}
input:focus { outline:none; border-color:#43a047; }

.btn { padding:10px; border:none; border-radius:10px; font-weight:600; cursor:pointer; transition: all 0.3s; }
.btn-primary { background: linear-gradient(90deg,#43a047,#66bb6a); color:white; }
.btn-primary:hover { background: linear-gradient(90deg,#388e3c,#43a047); }
.btn-secondary { background:#6c757d; color:white; }
.btn-secondary:hover { background:#5a6268; }

.alert { padding:10px; border-radius:8px; margin-bottom:10px; display:none; }
.alert-success { background:#d4edda; color:#155724; border:1px solid #c3e6cb; }
.alert-error { background:#f8d7da; color:#721c24; border:1px solid #f5c6cb; }

@media(max-width:900px){
    .main-content { flex-direction:column; }
    .form-section { width:100%; margin:10px; }
    #map { margin:10px; height:300px; }
}
</style>
</head>
<body>

<div class="header">
    <h1>EcoMarket</h1>
    <p>Puntos de Recolección</p>
    <a class="btn-back" href="/menu"> Volver al Menú Principal</a>
</div>

<div class="main-content">
    <div class="form-section">
        <h2 id="form-title">➕ Nuevo Punto de Recolección</h2>
        <div class="alert alert-success" id="success-alert"></div>
        <div class="alert alert-error" id="error-alert"></div>

        <form id="point-form">
            <input type="hidden" id="point-id">
            <div class="form-group">
                <label for="nombre">Nombre *</label>
                <input type="text" id="nombre" required>
            </div>
            <div class="form-group">
                <label for="direccion">Dirección *</label>
                <input type="text" id="direccion" required>
            </div>
            <div class="form-group">
                <label for="lat">Latitud *</label>
                <input type="text" id="lat" placeholder="Ej: 15.12345" required>
            </div>
            <div class="form-group">
                <label for="lng">Longitud *</label>
                <input type="text" id="lng" placeholder="Ej: -86.12345" required>
            </div>
            <div class="btn-group">
                <button type="submit" class="btn btn-primary" id="submit-btn">Guardar</button>
                <button type="button" class="btn btn-secondary" id="cancel-btn" style="display:none;">Cancelar</button>
            </div>
        </form>
    </div>

    <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const API_URL = '/api/points'; // Tu API real
let editMode = false;

// Inicializar mapa
const map = L.map('map').setView([15.0, -86.0], 7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'&copy; OpenStreetMap contributors' }).addTo(map);

// Cargar puntos desde API y agregar marcadores
async function loadPoints(){
    const res = await fetch(API_URL);
    const data = await res.json();
    if(!data.points) return;
    data.points.forEach(point=>{
        if(point.lat && point.lng){
            L.marker([point.lat, point.lng]).addTo(map)
             .bindPopup(`<b>${point.nombre}</b><br>${point.direccion}`);
        }
    });
}
loadPoints();

// Enviar formulario
document.getElementById('point-form').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const id = document.getElementById('point-id').value;
    const nombre = document.getElementById('nombre').value;
    const direccion = document.getElementById('direccion').value;
    const lat = document.getElementById('lat').value;
    const lng = document.getElementById('lng').value;

    const formData = new FormData();
    formData.append('nombre', nombre);
    formData.append('direccion', direccion);
    formData.append('lat', lat);
    formData.append('lng', lng);

    try{
        let url = API_URL, method='POST';
        if(editMode){ url=`${API_URL}/${id}`; method='PUT'; }

        const res = await fetch(url, { method, body: formData });
        if(res.ok){ alert(editMode?'Punto actualizado':'Punto agregado'); location.reload(); }
        else { const data = await res.json(); alert(data.detail || 'Error al guardar'); }
    }catch(err){ alert('Error en la conexión'); }
});

// Cancelar edición
document.getElementById('cancel-btn').addEventListener('click', ()=>{
    document.getElementById('point-form').reset();
    editMode=false;
});
</script>

</body>
</html>
