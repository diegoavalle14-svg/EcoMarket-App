{% extends "base.html" %}

{% block title %}Puntos de Recolección - EcoMarket{% endblock %}

{% block content %}
<div class="main-content" style="flex-direction:column; align-items:center; padding:20px;">
    <h1 style="text-align:center; margin-bottom:20px;">Puntos de Recolección</h1>
    <div id="map" style="width:90%; height:70vh; border-radius:15px; box-shadow:0 10px 25px rgba(76,175,80,0.3);"></div>

    <!-- BOTÓN VOLVER -->
    <a href="/" class="btn" style="
        margin-top:20px;
        display:inline-block;
        margin-bottom:15px;
        padding:10px 20px;
        background:linear-gradient(90deg,#43a047,#66bb6a);
        color:white;
        text-decoration:none;
        font-weight:600;
        border-radius:14px;
    ">Volver al Menú Principal</a>
</div>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
const API_URL = '/api/puntos';
const map = L.map('map').setView([15.0, -86.0], 7);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

// Crear ícono personalizado con borde usando divIcon
const recycleIcon = L.divIcon({
    html: `<img src="/static/images/recycle.png" style="
        width:32px;
        height:32px;
        border:2px solid black;
        border-radius:50%;
    ">`,
    className: '', // evitar clases predeterminadas
    iconSize: [32, 32],
    iconAnchor: [16, 32],
    popupAnchor: [0, -32]
});

async function loadPoints() {
    try {
        const res = await fetch(API_URL);
        const data = await res.json();
        if (!data.points) return;

        const bounds = [];

        data.points.forEach(point => {
            if (point.lat && point.lng) {
                const marker = L.marker([point.lat, point.lng], { icon: recycleIcon }).addTo(map)
                    .bindPopup(`<b>${point.nombre}</b><br>${point.direccion}`);
                bounds.push([point.lat, point.lng]);
            }
        });

        if (bounds.length) {
            map.fitBounds(bounds, { padding: [50, 50] });
        }

    } catch(err) {
        console.error("Error al cargar los puntos:", err);
    }
}

loadPoints();
</script>

{% endblock %}
