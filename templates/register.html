<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>EcoMarket - Registro de Usuarios</title>
<style>
/* ====== ESTILOS ====== */
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family: "Poppins", Arial, sans-serif; background: linear-gradient(135deg, #e8f5e9 0%, #6cbb80be 100%); padding: 40px; color: #2e7d32; }
.header { max-width: 600px; text-align:center; background: linear-gradient(90deg,#165c19,#9dcf9f); color:white; padding:35px; border-radius:40px; margin:0 auto 20px auto; box-shadow:0 6px 15px rgba(0,0,0,0.15); }
.header h1 { font-size:5em; font-weight:800; text-shadow:1px 2px 3px rgba(0,0,0,0.2); }
.container { max-width:400px; margin:auto; background:#fff; padding:35px; border-radius:25px; box-shadow:0 6px 20px rgba(76,175,80,0.15); border:2px solid #c8e6c9; transition: transform 0.3s ease, box-shadow 0.3s ease; }
h2 { color:#2e7d32; margin-bottom:25px; text-align:center; font-weight:800; font-size:28px; }
.form-group { margin-bottom:18px; }
label { display:block; margin-bottom:6px; color:#33691e; font-weight:600; font-size:14px; }
input { width:100%; padding:12px; border:1.5px solid #a5d6a7; border-radius:8px; font-size:15px; transition: all 0.3s ease; background-color:#f9fff9; }
input:focus { outline:none; border-color:#43a047; box-shadow:0 0 6px rgba(67,160,71,0.3); background-color:#fff; }
button { width:100%; padding:14px; background: linear-gradient(90deg,#43a047,#4caf50); color:white; border:none; border-radius:10px; font-size:16px; font-weight:600; cursor:pointer; margin-top:12px; transition: background 0.3s, transform 0.2s; }
button:hover { background: linear-gradient(90deg,#388e3c,#43a047); transform:scale(1.02); }
.login-link { text-align:center; margin-top:25px; font-size:15px; }
.login-link a { color:#388e3c; text-decoration:none; font-weight:600; transition: color 0.3s ease; }
.login-link a:hover { color:#1b5e20; }
.status-message { padding:10px; margin-top:15px; border-radius:5px; text-align:center; display:none; }
.status-message.success { background-color:#d4edda; color:#155724; }
.status-message.error { background-color:#f8d7da; color:#721c24; }
</style>
</head>
<body>

<div class="header"><h1>EcoMarket</h1></div>

<div class="container">
<h2>Registro</h2>

<form id="userForm" novalidate>
    <div class="form-group">
        <label for="firstName">Nombre:</label>
        <input type="text" id="firstName" name="first_name" required />
    </div>
    <div class="form-group">
        <label for="lastName">Apellido:</label>
        <input type="text" id="lastName" name="last_name" required />
    </div>
    <div class="form-group">
        <label for="username">Usuario:</label>
        <input type="text" id="username" name="username" required />
    </div>
    <div class="form-group">
        <label for="email">Correo:</label>
        <input type="email" id="email" name="email" required />
    </div>
    <div class="form-group">
        <label for="password">Contraseña:</label>
        <input type="password" id="password" name="password" required />
    </div>
    <button type="submit" id="submitBtn">Registrarse</button>
</form>

<div id="statusMessage" class="status-message"></div>

<div class="login-link">
    <p>¿Ya tienes cuenta? <a href="/login">Inicia sesión</a></p>
</div>
</div>

<script>
// Como este HTML lo sirve FastAPI desde el mismo dominio/puerto:
const API_BASE = '';

function validateForm(form) {
    const nameRegex = /^[A-Za-zÁÉÍÓÚáéíóúÑñ\s]+$/;
    const usernameRegex = /^[A-Za-z0-9_]{4,}$/;
    const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[\W_]).{8,}$/;

    if (!nameRegex.test(form.firstName.value.trim())) {
        alert("Nombre solo debe tener letras y espacios");
        return false;
    }
    if (!nameRegex.test(form.lastName.value.trim())) {
        alert("Apellido solo debe tener letras y espacios");
        return false;
    }
    if (!usernameRegex.test(form.username.value.trim())) {
        alert("Usuario mínimo 4 caracteres, solo letras, números y guiones bajos");
        return false;
    }
    if (!passwordRegex.test(form.password.value)) {
        alert("Contraseña debe tener mínimo 8 caracteres, incluyendo mayúscula, minúscula, número y símbolo");
        return false;
    }
    return true;
}

document.getElementById('userForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target;
    if (!validateForm(form)) return;

    const submitBtn = document.getElementById('submitBtn');
    const statusMessage = document.getElementById('statusMessage');

    const formData = new URLSearchParams({
        first_name: form.firstName.value.trim(),
        last_name: form.lastName.value.trim(),
        username: form.username.value.trim(),
        email: form.email.value.trim(),
        password: form.password.value.trim()
    });

    statusMessage.style.display='none';
    statusMessage.textContent='';
    submitBtn.disabled=true;
    submitBtn.textContent='Registrando...';

    try {
        const res = await fetch(`${API_BASE}/register`, {
            method:'POST',
            headers:{'Content-Type':'application/x-www-form-urlencoded'},
            body: formData
        });

        if (res.redirected) {
            // Si FastAPI hace RedirectResponse, el navegador lo sigue:
            window.location.href = res.url;
            return;
        }

        if (res.ok) {
            statusMessage.textContent = '¡Registro exitoso! Redirigiendo al login...';
            statusMessage.className='status-message success';
            statusMessage.style.display='block';
            setTimeout(()=>{ window.location.href='/login'; }, 1500);
        } else {
            const json = await res.json().catch(()=>({detail:'Error desconocido'}));
            statusMessage.textContent = json.detail || 'Error desconocido';
            statusMessage.className='status-message error';
            statusMessage.style.display='block';
        }
    } catch(err){
        statusMessage.textContent = `Error de conexión: ${err.message}`;
        statusMessage.className='status-message error';
        statusMessage.style.display='block';
    } finally {
        submitBtn.disabled=false;
        submitBtn.textContent='Registrarse';
    }
});
</script>

</body>
</html>
