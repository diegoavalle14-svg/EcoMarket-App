{% extends "base.html" %}
{% block content %}

<div class="solicitudes-layout">
  <div class="solicitudes-header">
    <div>
      <div class="solicitudes-title">
        <div class="solicitudes-title-icon">-></div>
        <span>Mis solicitudes</span>
      </div>
      <p class="solicitudes-subtitle">
        Envía solicitudes para donar, intercambiar o comprar materiales reciclables.
      </p>
    </div>
    <span class="solicitudes-badge">Panel de usuario</span>
  </div>

  <!-- Formulario -->
  <div class="solicitud-card">
    <div class="solicitud-card-header">
      <h3>Nueva solicitud</h3>
      <span>Completa los datos y envíalos al equipo de EcoMarket</span>
    </div>

    <form id="solicitudForm">
      <div class="solicitud-form-grid">
        <div>
          <label>Producto</label>
          <input id="producto" type="text" placeholder="Ej: Botellas PET, Televisor 32''" required>
        </div>

        <div>
          <label>Cantidad</label>
          <input id="cantidad" type="number" min="1" value="1" required>
        </div>

        <div>
          <label>Tipo</label>
          <select id="tipo" required>
            <option value="donar">Donar</option>
            <option value="intercambiar">Intercambiar</option>
            <option value="comprar">Comprar</option>
          </select>
        </div>

        <div>
          <label>Descripción (opcional)</label>
          <textarea id="descripcion" rows="3" placeholder="Detalles adicionales (medidas, estado, ubicación, etc.)"></textarea>
        </div>
      </div>

      <div class="solicitud-actions">
        <button type="submit" class="btn-primary">Enviar solicitud</button>
      </div>
    </form>
  </div>

  <!-- Mensajes -->
  <div id="mensajeEstado" class="alert alert-success"></div>

  <!-- Tabla -->
  <div class="card-table" style="margin-top:16px;">
    <div class="card-table-header">
      <h4>Historial de solicitudes</h4>
      <span>Revisa el estado de cada solicitud enviada</span>
    </div>
    <div class="table-scroll">
      <table class="table-modern">
        <thead>
          <tr>
            <th>ID</th>
            <th>Producto</th>
            <th>Cantidad</th>
            <th>Descripción</th>
            <th>Tipo</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody id="tablaSolicitudes">
          <tr><td colspan="6" style="padding:12px;color:#666">Cargando...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
async function fetchWithFallback(paths, options) {
  for (const p of paths) {
    try {
      const res = await fetch(p, options);
      if (res.status !== 404) return { res, path: p };
    } catch (e) {
      console.warn("fetch failed for", p, e);
    }
  }
  return null;
}
function candidate(path) { return [path, "/solicitudes" + path]; }

const msgBox = document.getElementById("mensajeEstado");

function mostrarMensaje(texto, esError = false) {
  msgBox.style.display = "block";
  msgBox.classList.toggle("alert-success", !esError);
  msgBox.classList.toggle("alert-error", esError);
  msgBox.textContent = texto;
}

function estadoChip(estadoRaw) {
  const e = (estadoRaw || "pendiente").toLowerCase();
  let cls = "status-pendiente";
  if (e === "aprobado") cls = "status-aprobado";
  if (e === "rechazado") cls = "status-rechazado";
  return `<span class="status-chip ${cls}">${e.toUpperCase()}</span>`;
}

async function cargarSolicitudes() {
  const attempt = await fetchWithFallback(candidate("/mis-solicitudes"));
  const tbody = document.getElementById("tablaSolicitudes");
  if (!attempt) {
    tbody.innerHTML = `<tr><td colspan="6" style="padding:12px;color:#c00">No se pudo conectar al endpoint de solicitudes.</td></tr>`;
    return;
  }
  const { res } = attempt;
  if (!res.ok) {
    tbody.innerHTML = `<tr><td colspan="6" style="padding:12px;color:#c00">Error al obtener solicitudes (status ${res.status}).</td></tr>`;
    return;
  }
  const data = await res.json();
  if (!Array.isArray(data) || data.length === 0) {
    tbody.innerHTML = `<tr><td colspan="6" style="padding:12px;color:#666">No tienes solicitudes enviadas.</td></tr>`;
    return;
  }

  tbody.innerHTML = data.map(s => `
    <tr>
      <td>${s.id}</td>
      <td>${escapeHtml(s.producto)}</td>
      <td>${s.cantidad}</td>
      <td>${escapeHtml(s.descripcion || '')}</td>
      <td>${escapeHtml(s.tipo)}</td>
      <td>${estadoChip(s.estado)}</td>
    </tr>`).join('');
}

document.getElementById("solicitudForm").addEventListener("submit", async e => {
  e.preventDefault();
  const payload = {
    producto: document.getElementById("producto").value.trim(),
    cantidad: parseInt(document.getElementById("cantidad").value, 10),
    descripcion: document.getElementById("descripcion").value.trim(),
    tipo: document.getElementById("tipo").value
  };
  if (!payload.producto || !payload.cantidad) {
    mostrarMensaje("Complete producto y cantidad.", true);
    return;
  }
  const attempt = await fetchWithFallback(candidate("/crear"), {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });
  if (!attempt) {
    mostrarMensaje("No se pudo conectar al servicio de solicitudes.", true);
    return;
  }
  const { res } = attempt;
  if (res.ok) {
    mostrarMensaje("Tu solicitud fue enviada. El estado inicial es PENDIENTE.");
    document.getElementById("solicitudForm").reset();
    cargarSolicitudes();
  } else {
    const txt = await res.text().catch(() => "");
    mostrarMensaje("Error al enviar solicitud. " + (txt || `status ${res.status}`), true);
  }
});

function escapeHtml(str) {
  return String(str || '').replace(/[&<>"']/g, m => ({
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#39;',
  }[m]));
}

cargarSolicitudes();
</script>

{% endblock %}
